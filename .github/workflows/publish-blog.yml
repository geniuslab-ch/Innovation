name: Publish Weekly Blog Post

on:
  schedule:
    # Tous les lundis à 8h UTC (9h heure suisse en hiver, 10h en été)
    - cron: '0 8 * * 1'
  workflow_dispatch: # Permet déclenchement manuel

permissions:
  contents: write  # Permission nécessaire pour push

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true  # Nécessaire pour git push
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Publish next article
        run: |
          # Vérifier s'il y a des articles à publier
          if [ ! -d "blog-drafts" ] || [ -z "$(ls -A blog-drafts/*.html 2>/dev/null)" ]; then
            echo "No articles to publish"
            exit 0
          fi
          
          # Prendre le premier article (ordre alphabétique)
          NEXT_ARTICLE=$(ls blog-drafts/*.html 2>/dev/null | head -1)
          
          if [ -z "$NEXT_ARTICLE" ]; then
            echo "No HTML articles found"
            exit 0
          fi
          
          ARTICLE_NAME=$(basename "$NEXT_ARTICLE")
          echo "Publishing: $ARTICLE_NAME"
          
          # Déplacer l'article vers le dossier principal
          mv "$NEXT_ARTICLE" .
          
          # Extraire les métadonnées de l'article
          TITLE=$(grep -oP '(?<=<h1>).*?(?=</h1>)' "$ARTICLE_NAME" | head -1)
          CATEGORY=$(grep -oP '(?<=<span class="blog-category">).*?(?=</span>)' "$ARTICLE_NAME" | head -1)
          DATE=$(date '+%d %B %Y' | sed 's/January/janvier/;s/February/février/;s/March/mars/;s/April/avril/;s/May/mai/;s/June/juin/;s/July/juillet/;s/August/août/;s/September/septembre/;s/October/octobre/;s/November/novembre/;s/December/décembre/')
          
          # Mettre à jour blog.html
          node scripts/update-blog-index.js "$ARTICLE_NAME" "$TITLE" "$CATEGORY" "$DATE"
          
          echo "Article published successfully!"
      
      - name: Commit and push changes
        run: |
          git config user.name "Blog Auto-Publisher"
          git config user.email "bot@geniuslab.ch"
          git add .
          
          # Vérifier s'il y a des changements avant de commit/push
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-publish: Weekly blog post"
            git push
          fi
